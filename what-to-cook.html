<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Everyone Chief · What to Cook</title>
<style>
:root{--bg:#fafafa;--card:#fff;--text:#222;--muted:#666;--brand:#5b7cfa;--line:#e9e9ee}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);padding:10px 16px;display:flex;gap:12px;align-items:center;z-index:9}
a{color:var(--brand);text-decoration:none}
.wrap{display:grid;grid-template-columns:2fr 1fr;gap:16px;padding:16px}
@media (max-width:1000px){.wrap{grid-template-columns:1fr}}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px}
.card{background:var(--card);border:1px solid var(--line);border-radius:12px;overflow:hidden;display:flex;flex-direction:column;cursor:pointer}
.card img{width:100%;height:150px;object-fit:cover;background:#ddd}
.card h3{margin:10px 12px 0;font-size:16px}
.meta{margin:6px 12px 10px;color:var(--muted);font-size:12px}
.actions{margin:8px 12px 12px;display:flex;gap:8px}
button{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 10px;cursor:pointer}
.btn-primary{background:var(--brand);color:#fff;border-color:var(--brand)}
.panel{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px;position:sticky;top:70px;height:fit-content}
.panel h2{margin:6px 0 10px;font-size:18px}
.row{display:flex;gap:8px;margin:6px 0}
input[type=text],textarea{width:100%;padding:8px;border:1px solid var(--line);border-radius:8px}
chips{display:flex;flex-wrap:wrap;gap:6px;margin:6px 0}
chip{background:#eef1ff;color:#2b3dbb;border:1px solid #dfe3ff;padding:3px 8px;border-radius:999px;font-size:12px;display:inline-flex;gap:6px;align-items:center}
.hint{color:var(--muted);font-size:12px}
.empty{color:var(--muted);padding:24px;text-align:center;border:1px dashed var(--line);border-radius:12px;background:#fff}
.toolbar{display:flex;gap:8px;align-items:center;margin:8px 0}
.pill{background:#eef1f7;border:1px solid #dee3ef;padding:2px 8px;border-radius:999px;font-size:12px;cursor:pointer}

/* modal */
dialog{border:none;border-radius:16px;max-width:760px;width:96%;padding:0;overflow:hidden}
.modal-head{display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--line);padding:10px 14px;background:#fff}
.modal-body{padding:14px;display:grid;grid-template-columns:240px 1fr;gap:16px}
.modal-body img{width:100%;height:220px;object-fit:cover;border-radius:8px;background:#ddd}
@media (max-width:720px){.modal-body{grid-template-columns:1fr}}
ul,ol{margin:6px 0 10px 18px}
</style>
</head>
<body>
<header>
  <strong>Everyone Chief · What to Cook</strong>
  <span id="today-pill" class="pill" title="Open Cook Dashboard"></span>
  <div style="margin-left:auto;display:flex;gap:14px">
    <a href="index.html">Home</a>
    <a href="who-cooks.html">Cook Dashboard</a>
  </div>
</header>

<div class="wrap">
  <section>
    <div class="toolbar">
      <input id="search" type="text" placeholder="Search dishes…"/>
      <button id="clearFilters">Clear</button>
      <span class="hint" id="countHint"></span>
    </div>
    <div id="dishGrid" class="grid"></div>
    <div id="emptyState" class="empty" style="display:none">No dishes yet. Add your first recipe →</div>
  </section>

  <aside class="panel">
    <h2 id="formTitle">Add a Recipe</h2>
    <div class="row"><input id="name" type="text" placeholder="Dish name (English)"/></div>

    <div class="row" style="align-items:center">
      <input id="image" type="file" accept="image/*" style="flex:1"/>
      <img id="preview" alt="preview" style="width:64px;height:48px;object-fit:cover;border:1px solid var(--line);border-radius:6px;display:none"/>
    </div>

    <div class="row">
      <input id="ingredientInput" type="text" placeholder="Ingredients (Enter or comma to add)"/>
      <button id="addIng">Add</button>
    </div>
    <chips id="ingredientList"></chips>

    <div class="row">
      <input id="toolInput" type="text" placeholder="Tools (Enter or comma to add)"/>
      <button id="addTool">Add</button>
    </div>
    <chips id="toolList"></chips>

    <div class="row">
      <input id="stepInput" type="text" placeholder="Cooking step (Enter to add)"/>
      <button id="addStep">Add</button>
    </div>
    <ol id="stepList" style="margin:6px 0 12px 22px;"></ol>

    <div class="row">
      <button class="btn-primary" id="save">Save</button>
      <button id="reset">Reset</button>
      <button id="delete" style="display:none">Delete</button>
    </div>
    <p class="hint">Tip: use Enter 添加条目；图片支持预览，若未选图将使用占位图。</p>
  </aside>
</div>

<!-- 详情 Modal -->
<dialog id="detail">
  <div class="modal-head">
    <strong id="mTitle">Dish</strong>
    <div style="display:flex;gap:8px;align-items:center">
      <input id="qty" type="number" min="1" value="1" style="width:68px;padding:6px;border:1px solid var(--line);border-radius:8px"/>
      <button id="mAdd">Add to Today</button>
      <button id="mClose">Close</button>
    </div>
  </div>
  <div class="modal-body">
    <img id="mImg" alt="">
    <div>
      <h3>Ingredients</h3><ul id="mIng"></ul>
      <h3>Tools</h3><ul id="mTools"></ul>
      <h3>Steps</h3><ol id="mSteps"></ol>
    </div>
  </div>
</dialog>

<script>
/* ---------- storage keys ---------- */
const LS = { DISHES:'ec_dishes', TODAY_PREFIX:'ec_today_' };
const todayKey = () => LS.TODAY_PREFIX + new Date().toISOString().slice(0,10);

/* ---------- placeholder image (base64 透明灰) ---------- */
const PLACEHOLDER = 'data:image/svg+xml;base64,' +
  btoa('<svg xmlns="http://www.w3.org/2000/svg" width="640" height="480"><rect width="100%" height="100%" fill="#e5e7eb"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#9ca3af" font-family="Arial" font-size="20">No Image</text></svg>');

/* ---------- data helpers ---------- */
function loadDishes(){
  const raw = localStorage.getItem(LS.DISHES);
  if(raw) return JSON.parse(raw);
  const seed = [
    {id: crypto.randomUUID(), name:'Kung Pao Chicken', image:'',
      ingredients:['chicken','peanuts','dried chili','soy sauce','vinegar','sugar','garlic','ginger'],
      tools:['wok','knife','spatula'],
      steps:['Dice chicken','Stir-fry chili & aromatics','Add sauce','Toss with peanuts and finish']},
    {id: crypto.randomUUID(), name:'Fried Rice', image:'',
      ingredients:['day-old rice','egg','scallion','peas','soy sauce','oil'],
      tools:['wok','spatula'],
      steps:['Scramble eggs','Add rice','Season and toss','Finish with scallions']},
    {id: crypto.randomUUID(), name:'Tomato Egg Stir-fry', image:'',
      ingredients:['tomatoes','eggs','salt','sugar','scallion'],
      tools:['pan','spatula','bowl'],
      steps:['Beat eggs & fry softly','Stir-fry tomatoes','Combine & season']}
  ];
  localStorage.setItem(LS.DISHES, JSON.stringify(seed));
  return seed;
}
function saveDishes(list){ localStorage.setItem(LS.DISHES, JSON.stringify(list)); }
function loadToday(){ const raw = localStorage.getItem(todayKey()); return raw? JSON.parse(raw):[]; }
function saveToday(x){ localStorage.setItem(todayKey(), JSON.stringify(x)); }

/* ---------- UI elements ---------- */
const grid = document.getElementById('dishGrid');
const empty = document.getElementById('emptyState');
const search = document.getElementById('search');
const countHint = document.getElementById('countHint');
const pill = document.getElementById('today-pill');

function updatePill(){
  const arr = loadToday();
  const total = arr.reduce((s,x)=>s+x.qty,0);
  pill.textContent = `Today: ${total} item${total!==1?'s':''}`;
}
pill.onclick = ()=> location.href = 'who-cooks.html';

/* ---------- render cards ---------- */
function renderGrid(filter=''){
  const dishes = loadDishes();
  const view = dishes.filter(d=>d.name.toLowerCase().includes(filter.toLowerCase()));
  grid.innerHTML = '';
  view.forEach(d=>{
    const card = document.createElement('div'); card.className='card';
    const img = document.createElement('img'); img.alt=d.name;
    img.src = d.image || PLACEHOLDER;
    img.onerror = ()=>{ img.src = PLACEHOLDER; };
    const h3 = document.createElement('h3'); h3.textContent = d.name;
    const meta = document.createElement('div'); meta.className='meta';
    meta.textContent = `${d.ingredients.length} ingredients · ${d.steps.length} steps`;
    const actions = document.createElement('div'); actions.className='actions';
    const viewBtn = document.createElement('button'); viewBtn.textContent='View';
    const addBtn = document.createElement('button'); addBtn.textContent='Add to Today'; addBtn.className='btn-primary';
    const editBtn = document.createElement('button'); editBtn.textContent='Edit';
    const delBtn = document.createElement('button'); delBtn.textContent='Delete';

    
    card.onclick = (e)=>{ if(e.target.tagName==='BUTTON') return; openModal(d.id); };
    viewBtn.onclick = ()=>openModal(d.id);
    addBtn.onclick = (e)=>{ e.stopPropagation(); addToToday(d.id,1); addBtn.textContent='Added ✓'; setTimeout(()=>addBtn.textContent='Add to Today',900); };
    editBtn.onclick = (e)=>{ e.stopPropagation(); startEdit(d.id); };
    delBtn.onclick = (e)=>{ e.stopPropagation(); deleteDish(d.id); };

    actions.append(viewBtn, addBtn, editBtn, delBtn);
    card.append(img,h3,meta,actions);
    grid.append(card);
  });
  empty.style.display = view.length? 'none':'block';
  countHint.textContent = `${view.length}/${loadDishes().length} shown`;
}

/* ---------- modal ---------- */
const modal = document.getElementById('detail');
const mTitle = document.getElementById('mTitle');
const mImg = document.getElementById('mImg');
const mIng = document.getElementById('mIng');
const mTools = document.getElementById('mTools');
const mSteps = document.getElementById('mSteps');
const mAdd = document.getElementById('mAdd');
const qty = document.getElementById('qty');
document.getElementById('mClose').onclick = ()=>modal.close();

function openModal(id){
  const d = loadDishes().find(x=>x.id===id); if(!d) return;
  mTitle.textContent = d.name;
  mImg.src = d.image || PLACEHOLDER; mImg.onerror = ()=>{ mImg.src = PLACEHOLDER; };
  mIng.innerHTML = d.ingredients.map(i=>`<li>${escapeHtml(i)}</li>`).join('');
  mTools.innerHTML = d.tools.map(i=>`<li>${escapeHtml(i)}</li>`).join('');
  mSteps.innerHTML = d.steps.map(i=>`<li>${escapeHtml(i)}</li>`).join('');
  qty.value = 1;
  mAdd.onclick = ()=>{ const n = Math.max(1, parseInt(qty.value||'1',10)); addToToday(d.id,n); mAdd.textContent='Added ✓'; setTimeout(()=>mAdd.textContent='Add to Today',900); };
  modal.showModal();
}

/* ---------- today helpers ---------- */
function addToToday(id, n=1){
  const arr = loadToday();
  const hit = arr.find(x=>x.id===id);
  if(hit){ hit.qty += n; } else { arr.push({id, qty:n, done:false}); }
  saveToday(arr); updatePill();
}

/* ---------- add / edit form ---------- */
const nameEl = document.getElementById('name');
const imgEl = document.getElementById('image');
const preview = document.getElementById('preview');
const ingInput = document.getElementById('ingredientInput');
const toolInput = document.getElementById('toolInput');
const stepInput = document.getElementById('stepInput');
const ingList = document.getElementById('ingredientList');
const toolList = document.getElementById('toolList');
const stepList = document.getElementById('stepList');
const saveBtn = document.getElementById('save');
const resetBtn = document.getElementById('reset');
const delBtn = document.getElementById('delete');
const formTitle = document.getElementById('formTitle');

let newIng=[], newTools=[], newSteps=[], newImgData=null, editingId=null;

function chip(text, removeFn){
  const c = document.createElement('chip');
  c.textContent = text + ' ';
  const x = document.createElement('button'); x.textContent='×'; x.style.border='none'; x.style.padding='0 4px'; x.style.cursor='pointer';
  x.onclick = removeFn; c.append(x); return c;
}
function redrawChips(){
  ingList.innerHTML=''; newIng.forEach((t,i)=>ingList.append(chip(t,()=>{newIng.splice(i,1);redrawChips();})));
  toolList.innerHTML=''; newTools.forEach((t,i)=>toolList.append(chip(t,()=>{newTools.splice(i,1);redrawChips();})));
  stepList.innerHTML=''; newSteps.forEach((s,i)=>{ const li=document.createElement('li'); li.textContent=s+' '; const b=document.createElement('button'); b.textContent='Remove'; b.onclick=()=>{newSteps.splice(i,1);redrawChips();}; li.append(b); stepList.append(li); });
}

function addTokens(input, arr){
  const raw = input.value.trim();
  if(!raw) return;
  raw.split(',').map(s=>s.trim()).filter(Boolean).forEach(tok=>arr.push(tok));
  input.value=''; redrawChips();
}
document.getElementById('addIng').onclick=()=>addTokens(ingInput,newIng);
document.getElementById('addTool').onclick=()=>addTokens(toolInput,newTools);
document.getElementById('addStep').onclick=()=>{ const v=stepInput.value.trim(); if(v){ newSteps.push(v); stepInput.value=''; redrawChips(); } };
[ingInput,toolInput,stepInput].forEach(inp=>inp.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); (inp===stepInput?document.getElementById('addStep'):inp===ingInput?document.getElementById('addIng'):document.getElementById('addTool')).click(); }}));

imgEl.onchange = e=>{
  const f = e.target.files?.[0]; if(!f){ newImgData=null; preview.style.display='none'; return; }
  const reader = new FileReader();
  reader.onload = ev => { newImgData = ev.target.result; preview.src=newImgData; preview.style.display='block'; };
  reader.readAsDataURL(f);
};

function resetForm(){
  formTitle.textContent='Add a Recipe';
  nameEl.value=''; [ingInput,toolInput,stepInput].forEach(i=>i.value='');
  newIng=[]; newTools=[]; newSteps=[]; newImgData=null; editingId=null; preview.style.display='none';
  redrawChips(); delBtn.style.display='none'; saveBtn.textContent='Save';
}
resetBtn.onclick = resetForm;

function startEdit(id){
  const d = loadDishes().find(x=>x.id===id); if(!d) return;
  formTitle.textContent='Edit Recipe';
  nameEl.value = d.name;
  newIng = [...d.ingredients]; newTools=[...d.tools]; newSteps=[...d.steps];
  newImgData = d.image || null;
  preview.src = d.image || PLACEHOLDER; preview.style.display='block';
  editingId = d.id; redrawChips(); delBtn.style.display='inline-block'; saveBtn.textContent='Save changes';
  window.scrollTo({top:0,behavior:'smooth'});
}

function deleteDish(id){
  if(!confirm('Delete this recipe?')) return;
  const dishes = loadDishes().filter(x=>x.id!==id); saveDishes(dishes);
  const t = loadToday().filter(x=>x.id!==id); saveToday(t);
  updatePill(); renderGrid(search.value.trim());
  if(editingId===id) resetForm();
}

saveBtn.onclick = ()=>{
  const name = (nameEl.value||'').trim();
  if(!name){ alert('Please enter a dish name.'); return; }
  const dishes = loadDishes();
  if(editingId){
    const d = dishes.find(x=>x.id===editingId); if(!d) return;
    d.name = name; d.ingredients=[...newIng]; d.tools=[...newTools]; d.steps=[...newSteps];
    d.image = newImgData || d.image || '';
  }else{
    dishes.push({ id:crypto.randomUUID(), name, image:newImgData||'', ingredients:[...newIng], tools:[...newTools], steps:[...newSteps] });
  }
  saveDishes(dishes); renderGrid(search.value.trim()); resetForm(); alert('Saved!');
};
delBtn.onclick = ()=>{ if(editingId) deleteDish(editingId); };

/* ---------- search / clear ---------- */
document.getElementById('clearFilters').onclick = ()=>{ search.value=''; renderGrid(''); }
search.addEventListener('input', e=> renderGrid(e.target.value));

/* ---------- init ---------- */
function escapeHtml(s){ return (s??'').toString().replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
updatePill(); renderGrid();
</script>
</body>
</html>
